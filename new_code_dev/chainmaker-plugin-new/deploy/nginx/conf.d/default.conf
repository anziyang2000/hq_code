load_module modules/ngx_http_js_module.so;

events { }


http {

    # 链当前限制是10MB，超过会报业务级报错，因此这里就不再限制了，nginx默认为1MB
    client_max_body_size 0;

    js_path "/etc/nginx/njs/";

    js_import main from upload.js;

    # 10分钟，http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_read_timeout
    proxy_read_timeout 600s;

server {
    # 开启SSL，需要listen ssl
    listen       9080;
    server_name  localhost;
    underscores_in_headers on;

    # ssl_certificate /etc/nginx/cert/fullchain.pem;
    # ssl_certificate_key /etc/nginx/cert/privkey.pem;

    location / {

     # 代理配置说明见http://nginx.org/en/docs/http/ngx_http_grpc_module.html#grpc_pass
           grpc_set_header     Content-Type application/grpc;
            # 非SSL
           grpc_pass  grpc://$http_x_grpc_node;

        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' "*";
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, DELETE';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Transfer-Encoding,Custom-Header-1,X-Accept-Content-Transfer-Encoding,X-Accept-Response-Streaming,X-User-Agent,X-Grpc-Web,X-Grpc-node';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
        }

        if ($request_method = 'POST') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Transfer-Encoding,Custom-Header-1,X-Accept-Content-Transfer-Encoding,X-Accept-Response-Streaming,X-User-Agent,X-Grpc-Web,X-Grpc-node';
            add_header 'Access-Control-Expose-Headers' 'Content-Transfer-Encoding,Grpc-Message,Grpc-Status';
        }
    }
}
server {
    # 开启SSL，需要listen ssl
    listen       9081;
    server_name  localhost;
    underscores_in_headers on;

    # ssl_certificate /etc/nginx/cert/fullchain.pem;
    # ssl_certificate_key /etc/nginx/cert/privkey.pem;

    location /upload-cert {
        js_content main.resolve;
    }

    location / {

            # SSL
            grpc_set_header     Content-Type application/grpc;
            grpc_pass    grpcs://$http_x_grpc_node;

            grpc_ssl_certificate /var/www/ssl/$http_x_grpc_ssl_cert;
            grpc_ssl_certificate_key /var/www/ssl/$http_x_grpc_ssl_cert_key;
            grpc_ssl_name $http_x_grpc_ssl_target_name_override;
            grpc_ssl_server_name on;

#             grpc_ssl_trusted_certificate /var/www/ssl/ca.crt;
#             grpc_ssl_verify on;
#             grpc_ssl_verify_depth 3;
#             grpc_ssl_protocols SSLv2 SSLv3 TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;

        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' "*";
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, DELETE';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Transfer-Encoding,Custom-Header-1,X-Accept-Content-Transfer-Encoding,X-Accept-Response-Streaming,X-User-Agent,X-Grpc-Web,X-Grpc-node';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
        }

        if ($request_method = 'POST') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Transfer-Encoding,Custom-Header-1,X-Accept-Content-Transfer-Encoding,X-Accept-Response-Streaming,X-User-Agent,X-Grpc-Web,X-Grpc-node';
            add_header 'Access-Control-Expose-Headers' 'Content-Transfer-Encoding,Grpc-Message,Grpc-Status';
        }
    }
}
}
